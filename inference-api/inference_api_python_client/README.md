# Bunkerhill Health Inference API Python Client

Contains a Python client for the Bunkerhill Inference API, which allows third-party applications to access inferences generated from Bunkerhill models.

## Table of contents

1. [Overview](#overview)
2. [Installation](#installation)
3. [Credentials](#credentials)
4. [Usage Instructions](#usage-instructions)
5. [API Reference](#api-reference)

## Overview

The inference API allows third parties to integrate Bunkerhill data into their applications. Such applications can authenticate into Bunkerhill's system and access data generated by models, with the ability to filter by fields such as model ID and patient MRN.

## Installation

### From package management

Coming soon

### From source

To install from source, clone the repo locally. Then run the following

```
python -m pip install inference-api/python_client/
```

## Credentials

Authentication to the server depends on the use of a username / private key combination. Please obtain these credentials from Bunkerhill Health by reaching out to # TODO - insert email. The private key should be stored locally and securely, for example in a file named `private_key.pem`.

The credentials are exchanged with the server for a JWT access token, which is managed by the Python client and automatically passed with all API requests.

## Usage Instructions

Once installed, import the library into your Python file and make calls to the API using the `InferenceAPIClient`.

For example, to query for all inferences for patient with mrn `$PATIENT_MRN` and model ID `$MODEL_ID`, and download the predections generated for those inferences to `$DIRNAME`, run:

```
from inference_api_python_client import InferenceAPIClient

client = InferenceAPIClient(
  username='$USERNAME',
  private_key_filename='private_key.pem',
)

inference_list = client.get_inferences(
  model_id='$MODEL_ID',
  patient_mrn='$PATIENT_MRN',
  segmentation_destination_dirname='$DIRNAME',
)
```

## API Reference

### InferenceAPIClient

#### Constructor
```
InferenceAPIClient(
  username: str,
  private_key_filename: Optional[str] = None,
  private_key_string: Optional[str] = None,
  base_url: str = 'https://api.bunkerhillhealth.com/',
 )
```

##### Parameters:

username (str): The username to authenticate the client.\
private_key_filename (Optional[str]): Filename of the RSA private key.\
private_key_string (Optional[str]): The RSA private key as a string.\
base_url (str, optional): The base URL of the Django API. Defaults to 'https://api.bunkerhillhealth.com/'.

_Note:_ At least one of private_key_filename or private_key_string must be provided.

#### get_inferences
```
get_inferences(
  model_id: str,
  patient_mrn: str,
  segmentation_destination_dirname: str,
) -> List[Inference]
```

Fetches a list of Inference objects for a given patient and a given model from the Inference API.

##### Parameters:
model_id (str): The model ID to fetch inferences for. \
patient_mrn (str): The medical record number (MRN) of the patient. \
segmentation_destination_dirname (str): The directory where the downloaded segmentation data will be stored.

##### Returns:
List[Inference]: A list of Inference objects.

_Notes:_

- As a side effect, this method downloads the segmentations corresponding to the fetched inferences to `segmentation_destination_dirname`.
- You must have authorization to the specified `model_id` - if not, a 403 error will be raised.
- Only inferences corresponding to institutions that you are authorized to will be returned.

#### get_inferences_async

```
get_inferences_async(
  model_id: str,
  patient_mrn: str,
  segmentation_destination_dirname: str,
 ) -> List[Inference]
```
Asynchronous version of `get_inferences`. The `get_inferences_async` method should be used when running the client in an environment that supports asynchronous tasks, especially when handling larger data sets.

### Inference

Inference is a TypedDict containing information about a single inference returned by the API.

#### Fields

`model_id: str`

The model identifier for the inference.

`patient_mrn: str`

The medical record number (MRN) of the patient for whom the inference was made.

`segmentation_presigned_urls: List[str]`

A list of presigned URLs for accessing the segmentation data related to the inference.
